name: TASK012X - Catalog: show full images (contain) + 4 cards per row

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  task012X:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Overwrite pages/catalog.vue
        shell: bash
        run: |
          mkdir -p pages
          cat > pages/catalog.vue <<'EOF'
          <template>
            <div class="grid gap-6">
              <div class="rounded-2xl border bg-white p-5 shadow-sm">
                <h1 class="text-xl font-bold">Каталог ліків</h1>
                <p class="mt-1 text-sm text-gray-600">Оберіть препарати та додайте в кошик.</p>
              </div>

              <div v-if="loading" class="text-sm text-gray-600">Завантаження...</div>

              <div v-else class="grid gap-4">
                <!-- 4 cards per row on large screens -->
                <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-4">
                  <div
                    v-for="p in products"
                    v-bind:key="p.id"
                    class="rounded-2xl border bg-white p-3 shadow-sm hover:shadow-md transition-shadow"
                  >
                    <!-- IMAGE: smaller and NOT cropped -->
                    <div class="rounded-xl border bg-white p-2">
                      <div class="h-28 w-full">
                        <img
                          v-if="imageSrc(p)"
                          v-bind:src="imageSrc(p)"
                          alt=""
                          class="h-full w-full object-contain"
                        />
                      </div>
                    </div>

                    <!-- text (font unchanged) -->
                    <div class="mt-3 grid gap-1">
                      <div class="line-clamp-2 text-sm font-semibold text-gray-900">
                        {{ p.name }}
                      </div>

                      <div class="text-xs text-gray-500">
                        {{ p.parentCategory }} / {{ p.childCategory }}
                      </div>

                      <div class="mt-1 flex items-center justify-between gap-2">
                        <div class="text-sm font-bold text-gray-900">
                          {{ formatPrice(p.price) }}
                        </div>
                        <div class="text-xs text-gray-500">
                          {{ p.unit }}
                        </div>
                      </div>

                      <UiButton class="mt-2 w-full" v-on:click="addToCart(p)">
                        Додати в кошик
                      </UiButton>
                    </div>
                  </div>
                </div>

                <div v-if="products.length === 0" class="text-sm text-gray-600">
                  Товарів поки немає.
                </div>
              </div>
            </div>
          </template>

          <script setup lang="ts">
          import { useCartStore } from '~/stores/cart'

          const cart = useCartStore()
          const { products, loading, fetchAll } = useProducts() as any

          onMounted(async () => {
            // щоб не ловити SSR 500 (як у тебе раніше)
            await requireRole('client')
            await fetchAll()
          })

          function formatPrice(v: any) {
            const n = Number(v || 0)
            return `${n.toFixed(2)} грн`
          }

          function normalizeLocalImagePath(imagePath: string) {
            const raw = String(imagePath || '').trim().replace(/\\/g, '/')
            if (!raw) return ''
            const rel = raw.includes('/') ? raw.replace(/^\/+/, '') : `images/${raw}`
            return '/' + rel
          }

          function imageSrc(p: any) {
            // Storage wins if exists
            if (p?.imageUrl) return String(p.imageUrl)
            if (p?.imagePath) return normalizeLocalImagePath(String(p.imagePath))
            return ''
          }

          function addToCart(p: any) {
            cart.add({
              productId: p.id,
              name: p.name,
              price: Number(p.price || 0),
              qty: 1
            })
          }
          </script>
          EOF

      - name: Commit & push
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pages/catalog.vue
          git commit -m "TASK012: catalog 4-up grid + full images (contain) + smaller image block" || echo "No changes to commit"
          git push
